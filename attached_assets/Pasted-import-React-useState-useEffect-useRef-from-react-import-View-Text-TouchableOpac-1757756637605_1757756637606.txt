import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  Alert,
  Dimensions,
  SafeAreaView,
  StatusBar,
  Vibration,
} from 'react-native';
import Voice from '@react-native-voice/voice';
import Tts from 'react-native-tts';

const { width, height } = Dimensions.get('window');

const FarmerVoiceScreen = () => {
  const [isListening, setIsListening] = useState(false);
  const [recognizedText, setRecognizedText] = useState('');
  const [currentLanguage, setCurrentLanguage] = useState('hi-IN');
  const [isFirstLaunch, setIsFirstLaunch] = useState(true);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [currentMenu, setCurrentMenu] = useState('main');
  const [repeatCount, setRepeatCount] = useState(0);
  const instructionTimer = useRef(null);

  // Enhanced messages for low-literate users with simpler language
  const messages = {
    greeting: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§π‡•Ç‡§Ç‡•§ ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§∏‡•Å‡§®‡•Ç‡§Ç‡§ó‡§æ‡•§ ‡§¨‡§°‡§º‡•á ‡§π‡§∞‡•á ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§¶‡§¨‡§æ‡§ï‡§∞ ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§",
    mainMenu: "‡§Ü‡§™ ‡§ï‡§π ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç - ‡§Æ‡•å‡§∏‡§Æ, ‡§ï‡•Ä‡§Æ‡§§, ‡§Ø‡§æ ‡§Æ‡§¶‡§¶‡•§ ‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§∞‡§æ ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç‡•§",
    weather: "‡§Ü‡§ú ‡§ß‡•Ç‡§™ ‡§π‡•à‡•§ ‡§§‡§æ‡§™‡§Æ‡§æ‡§® 28 ‡§°‡§ø‡§ó‡•ç‡§∞‡•Ä ‡§π‡•à‡•§ ‡§¨‡§æ‡§∞‡§ø‡§∂ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡•Ä‡•§ ‡§ñ‡•á‡§§ ‡§ï‡§æ ‡§ï‡§æ‡§Æ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§",
    prices: "‡§ó‡•á‡§π‡•Ç‡§Ç 2000 ‡§∞‡•Å‡§™‡§Ø‡•á ‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤‡•§ ‡§ö‡§æ‡§µ‡§≤ 1800 ‡§∞‡•Å‡§™‡§Ø‡•á ‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤‡•§ ‡§™‡•ç‡§Ø‡§æ‡§ú‡§º 30 ‡§∞‡•Å‡§™‡§Ø‡•á ‡§ï‡§ø‡§≤‡•ã‡•§",
    help: "‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡•Ç‡§Ç‡§ó‡§æ‡•§ ‡§π‡§∞‡§æ ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§¨‡•ã‡§≤‡•á‡§Ç - ‡§Æ‡•å‡§∏‡§Æ, ‡§ï‡•Ä‡§Æ‡§§, ‡§Ø‡§æ ‡§Æ‡§¶‡§¶‡•§",
    listening: "‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç... ‡§¨‡•ã‡§≤‡§ø‡§è",
    notUnderstood: "‡§Æ‡•à‡§Ç ‡§∏‡§Æ‡§ù ‡§®‡§π‡•Ä‡§Ç ‡§™‡§æ‡§Ø‡§æ‡•§ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§ ‡§π‡§∞‡§æ ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç‡•§",
    error: "‡§ï‡•ã‡§à ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•à‡•§ ‡§´‡§ø‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§π‡§∞‡§æ ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç‡•§",
    buttonPress: "‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ",
    menuRepeat: "‡§Æ‡•à‡§Ç ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§¨‡§§‡§æ‡§§‡§æ ‡§π‡•Ç‡§Ç",
    goodbye: "‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§´‡§ø‡§∞ ‡§Æ‡§ø‡§≤‡•á‡§Ç‡§ó‡•á‡•§",
    slowDown: "‡§Æ‡•à‡§Ç ‡§ß‡•Ä‡§∞‡•á ‡§¨‡•ã‡§≤‡•Ç‡§Ç‡§ó‡§æ",
    confirmation: "‡§†‡•Ä‡§ï ‡§π‡•à, ‡§∏‡§Æ‡§ù ‡§ó‡§Ø‡§æ",
  };

  // Simple voice commands for low-literate users
  const simpleCommands = {
    weather: ['‡§Æ‡•å‡§∏‡§Æ', 'weather', '‡§¨‡§æ‡§∞‡§ø‡§∂', '‡§ß‡•Ç‡§™', '‡§†‡§Ç‡§°'],
    prices: ['‡§ï‡•Ä‡§Æ‡§§', '‡§≠‡§æ‡§µ', 'price', '‡§¶‡§æ‡§Æ', '‡§∞‡•á‡§ü'],
    help: ['‡§Æ‡§¶‡§¶', 'help', '‡§∏‡§π‡§æ‡§Ø‡§§‡§æ', '‡§¨‡§§‡§æ‡§ì'],
    repeat: ['‡§´‡§ø‡§∞', '‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ', 'repeat', 'again'],
    slow: ['‡§ß‡•Ä‡§∞‡•á', 'slow', '‡§Ü‡§∞‡§æ‡§Æ'],
    bye: ['‡§¨‡§æ‡§Ø', 'bye', '‡§ú‡§æ‡§®‡§æ', '‡§¨‡§Ç‡§¶'],
  };

  useEffect(() => {
    // Configure TTS for low-literate users
    Tts.setDefaultLanguage(currentLanguage);
    Tts.setDefaultRate(0.4); // Very slow speech
    Tts.setDefaultPitch(0.9); // Slightly lower pitch for clarity
    
    // Voice recognition setup
    Voice.onSpeechStart = onSpeechStart;
    Voice.onSpeechRecognized = onSpeechRecognized;
    Voice.onSpeechEnd = onSpeechEnd;
    Voice.onSpeechError = onSpeechError;
    Voice.onSpeechResults = onSpeechResults;

    // TTS event listeners
    Tts.addEventListener('tts-start', () => setIsSpeaking(true));
    Tts.addEventListener('tts-finish', () => {
      setIsSpeaking(false);
      // Auto-repeat instructions after 10 seconds of inactivity
      if (repeatCount < 2) {
        instructionTimer.current = setTimeout(() => {
          speakText(messages.mainMenu);
          setRepeatCount(prev => prev + 1);
        }, 10000);
      }
    });
    Tts.addEventListener('tts-cancel', () => setIsSpeaking(false));

    // Welcome sequence for first-time users
    if (isFirstLaunch) {
      setTimeout(() => {
        speakText(messages.greeting);
        setTimeout(() => {
          speakText(messages.mainMenu);
        }, 4000);
        setIsFirstLaunch(false);
      }, 1500);
    }

    return () => {
      Voice.destroy().then(Voice.removeAllListeners);
      Tts.removeAllListeners('tts-start');
      Tts.removeAllListeners('tts-finish');
      Tts.removeAllListeners('tts-cancel');
      if (instructionTimer.current) {
        clearTimeout(instructionTimer.current);
      }
    };
  }, [currentLanguage, repeatCount]);

  const onSpeechStart = () => {
    setIsListening(true);
    setRecognizedText('üéô ‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç...');
    Vibration.vibrate(100); // Haptic feedback
    if (instructionTimer.current) {
      clearTimeout(instructionTimer.current);
    }
  };

  const onSpeechRecognized = () => {
    // Provide audio feedback that speech was recognized
    Vibration.vibrate([50, 50, 50]);
  };

  const onSpeechEnd = () => {
    setIsListening(false);
    setRecognizedText('‚úÖ ‡§∏‡•Å‡§® ‡§≤‡§ø‡§Ø‡§æ');
  };

  const onSpeechError = (error) => {
    console.log('Speech Error:', error);
    setIsListening(false);
    setRecognizedText('‚ùå ‡§´‡§ø‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç');
    Vibration.vibrate(200);
    setTimeout(() => {
      speakText(messages.error);
    }, 500);
  };

  const onSpeechResults = (event) => {
    const spokenText = event.value[0].toLowerCase();
    setRecognizedText(‚úÖ "${event.value[0]}");
    setRepeatCount(0); // Reset repeat counter on successful recognition
    
    // Process with confirmation
    setTimeout(() => {
      speakText(messages.confirmation);
      setTimeout(() => {
        processVoiceCommand(spokenText);
      }, 1500);
    }, 500);
  };

  const processVoiceCommand = (command) => {
    let commandFound = false;

    // Check each command category
    for (const [category, keywords] of Object.entries(simpleCommands)) {
      if (keywords.some(keyword => command.includes(keyword))) {
        commandFound = true;
        handleCommand(category);
        break;
      }
    }

    if (!commandFound) {
      speakText(${messages.notUnderstood} ${messages.mainMenu});
    }
  };

  const handleCommand = (command) => {
    switch (command) {
      case 'weather':
        speakText(messages.weather);
        break;
      case 'prices':
        speakText(messages.prices);
        break;
      case 'help':
        speakText(${messages.help} ${messages.mainMenu});
        break;
      case 'repeat':
        speakText(${messages.menuRepeat}. ${messages.mainMenu});
        break;
      case 'slow':
        Tts.setDefaultRate(0.3);
        speakText(${messages.slowDown}. ${messages.mainMenu});
        break;
      case 'bye':
        speakText(messages.goodbye);
        break;
      default:
        speakText(messages.mainMenu);
    }
  };

  const speakText = (text) => {
    if (isSpeaking) {
      Tts.stop();
    }
    Tts.speak(text);
  };

  const startListening = async () => {
    try {
      setRecognizedText('');
      await Voice.start(currentLanguage);
      // Audio confirmation
      setTimeout(() => {
        if (isListening) {
          speakText(messages.listening);
        }
      }, 1000);
    } catch (error) {
      console.log('Start Listening Error:', error);
      speakText(messages.error);
    }
  };

  const stopListening = async () => {
    try {
      await Voice.stop();
      setIsListening(false);
    } catch (error) {
      console.log('Stop Listening Error:', error);
    }
  };

  const handleMicPress = () => {
    Vibration.vibrate(50);
    speakText(messages.buttonPress);
    setTimeout(() => {
      if (isListening) {
        stopListening();
      } else {
        startListening();
      }
    }, 800);
  };

  const handleRepeatPress = () => {
    Vibration.vibrate(50);
    speakText(messages.menuRepeat);
    setTimeout(() => {
      speakText(messages.mainMenu);
    }, 1500);
  };

  return (
    <SafeAreaView style={styles.container}>
      <StatusBar backgroundColor="#4CAF50" barStyle="light-content" />
      
      {/* Simplified Header with large text */}
      <View style={styles.header}>
        <Text style={styles.headerText}>üåæ ‡§ï‡§ø‡§∏‡§æ‡§® ‡§Æ‡§ø‡§§‡•ç‡§∞</Text>
        <Text style={styles.subHeaderText}>‡§Ü‡§µ‡§æ‡§ú‡§º ‡§∏‡•á ‡§¨‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç</Text>
      </View>

      {/* Main Content */}
      <View style={styles.content}>
        {/* Large Status Display */}
        <View style={styles.statusContainer}>
          <Text style={styles.statusIcon}>
            {isListening ? 'üéô' : isSpeaking ? 'üîä' : 'üëÇ'}
          </Text>
          <Text style={styles.statusText}>
            {isListening ? '‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç...' : 
             isSpeaking ? '‡§¨‡•ã‡§≤ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç...' : 
             '‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•Ç‡§Ç'}
          </Text>
          {recognizedText ? (
            <Text style={styles.recognizedText}>{recognizedText}</Text>
          ) : null}
        </View>

        {/* Large Action Buttons */}
        <View style={styles.buttonContainer}>
          {/* Main Mic Button - Extra Large */}
          <TouchableOpacity
            style={[styles.mainButton, isListening && styles.mainButtonActive]}
            onPress={handleMicPress}
            disabled={isSpeaking}
          >
            <Text style={styles.mainButtonIcon}>
              {isListening ? 'üî¥' : 'üéô'}
            </Text>
            <Text style={styles.mainButtonText}>
              {isListening ? '‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç' : '‡§Ø‡§π‡§æ‡§Å ‡§¶‡§¨‡§æ‡§è‡§Ç'}
            </Text>
            <Text style={styles.mainButtonSubtext}>
              {isListening ? '‡§Ö‡§¨ ‡§¨‡•ã‡§≤‡•á‡§Ç' : '‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è'}
            </Text>
          </TouchableOpacity>

          {/* Repeat Button */}
          <TouchableOpacity
            style={styles.repeatButton}
            onPress={handleRepeatPress}
            disabled={isSpeaking}
          >
            <Text style={styles.repeatIcon}>üîÑ</Text>
            <Text style={styles.repeatButtonText}>‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§∏‡•Å‡§®‡•á‡§Ç</Text>
          </TouchableOpacity>
        </View>

        {/* Simple Visual Instructions */}
        <View style={styles.instructionsContainer}>
          <Text style={styles.instructionsTitle}>‡§¨‡•ã‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:</Text>
          <View style={styles.instructionRow}>
            <Text style={styles.instructionEmoji}>üå§</Text>
            <Text style={styles.instructionText}>"‡§Æ‡•å‡§∏‡§Æ"</Text>
          </View>
          <View style={styles.instructionRow}>
            <Text style={styles.instructionEmoji}>üí∞</Text>
            <Text style={styles.instructionText}>"‡§ï‡•Ä‡§Æ‡§§"</Text>
          </View>
          <View style={styles.instructionRow}>
            <Text style={styles.instructionEmoji}>‚ùì</Text>
            <Text style={styles.instructionText}>"‡§Æ‡§¶‡§¶"</Text>
          </View>
        </View>
      </View>

      {/* Footer with current status */}
      <View style={styles.footer}>
        <Text style={styles.footerText}>
          {isSpeaking ? 'üîä ‡§¨‡•ã‡§≤ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç...' : 
           isListening ? 'üëÇ ‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç...' : 
           '‚úÖ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•Ç‡§Ç - ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç'}
        </Text>
      </View>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F1F8E9',
  },
  header: {
    backgroundColor: '#4CAF50',
    paddingVertical: 25,
    paddingHorizontal: 20,
    alignItems: 'center',
    elevation: 4,
  },
  headerText: {
    fontSize: 28,
    fontWeight: 'bold',
    color: 'white',
    textAlign: 'center',
  },
  subHeaderText: {
    fontSize: 16,
    color: '#E8F5E8',
    marginTop: 5,
  },
  content: {
    flex: 1,
    paddingHorizontal: 20,
    paddingVertical: 20,
  },
  statusContainer: {
    backgroundColor: 'white',
    borderRadius: 20,
    padding: 30,
    marginBottom: 25,
    alignItems: 'center',
    elevation: 3,
    minHeight: 140,
    justifyContent: 'center',
  },
  statusIcon: {
    fontSize: 48,
    marginBottom: 10,
  },
  statusText: {
    fontSize: 22,
    color: '#2E7D32',
    fontWeight: 'bold',
    textAlign: 'center',
    marginBottom: 10,
  },
  recognizedText: {
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
    fontStyle: 'italic',
  },
  buttonContainer: {
    marginBottom: 25,
  },
  mainButton: {
    backgroundColor: '#4CAF50',
    borderRadius: 25,
    padding: 30,
    alignItems: 'center',
    marginBottom: 20,
    elevation: 5,
    minHeight: 160,
    justifyContent: 'center',
  },
  mainButtonActive: {
    backgroundColor: '#FF5722',
  },
  mainButtonIcon: {
    fontSize: 48,
    marginBottom: 10,
  },
  mainButtonText: {
    color: 'white',
    fontSize: 24,
    fontWeight: 'bold',
    textAlign: 'center',
    marginBottom: 5,
  },
  mainButtonSubtext: {
    color: '#E8F5E8',
    fontSize: 16,
    textAlign: 'center',
  },
  repeatButton: {
    backgroundColor: '#2196F3',
    borderRadius: 20,
    padding: 20,
    alignItems: 'center',
    elevation: 3,
  },
  repeatIcon: {
    fontSize: 32,
    marginBottom: 8,
  },
  repeatButtonText: {
    color: 'white',
    fontSize: 18,
    fontWeight: 'bold',
  },
  instructionsContainer: {
    backgroundColor: 'white',
    borderRadius: 20,
    padding: 25,
    elevation: 2,
  },
  instructionsTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#2E7D32',
    marginBottom: 20,
    textAlign: 'center',
  },
  instructionRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 15,
    paddingHorizontal: 10,
  },
  instructionEmoji: {
    fontSize: 28,
    marginRight: 20,
    width: 40,
  },
  instructionText: {
    fontSize: 20,
    color: '#4CAF50',
    fontWeight: '600',
  },
  footer: {
    backgroundColor: '#E8F5E8',
    paddingVertical: 20,
    alignItems: 'center',
    borderTopWidth: 2,
    borderTopColor: '#C8E6C9',
  },
  footerText: {
    fontSize: 18,
    color: '#2E7D32',
    fontWeight: '600',
    textAlign: 'center',
  },
});

export default FarmerVoiceScreen;